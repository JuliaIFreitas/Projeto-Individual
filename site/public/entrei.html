<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENTREI - JULIA INADA DE FREITAS</title>
    <link rel="stylesheet" href="./css/entrei.css">
    <link rel="stylesheet" href="./css/modal.css">
    <!-- <script src="../src/js/addkata.js"></script> -->
    <!-- <script src="../src/js/script.js"></script> -->
    <!-- <script src="../src/js/entrei.js"></script> -->

    <style>
        /* ASSOCIAÇÃO */
        .modalAsso {
            width: 60%;
            height: 90%;
            position: fixed;
            top: 0;
            left: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1;
            overflow: auto;
            margin: 2% 20%;
            border-radius: 5%;
            box-shadow: 0 5px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 10px 1000px rgba(0, 0, 0, 0.491);
        }

        .modalAsso .modalassociacao {
            width: 50%;
            min-width: 400px;
            min-height: 300px;
            background-color: rgba(235, 144, 144, 0.75);
            backdrop-filter: blur(10px);
            height: 70%;
            padding: 10%;
            border-radius: 5%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }

        /* .modalAsso .modalassociacao img {
    width: 120%;
    height: 100%;
    cursor: pointer;
} */

        .modalAsso.abrir {
            display: flex;
        }

        @keyframes abrir {
            from {
                opacity: 0;
                transform: translate3d(0, -20px, -5px);
            }

            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        .abrir .modalAsso {
            animation: abrirfaixa 0.5s;
        }

        .fechar {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 8%;
            height: 8%;
            border-radius: 50%;
            border: 0;
            background-color: rgb(116, 54, 54);
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <!-- <script src="/site/src/js/login.js"></script> -->

    <div class="arm">
        <div class="alerta_erro">
            <div class="card_erro" id="cardErro">
                <span id="mensagem_erro"></span>
            </div>
        </div>

        <div class="modalAsso" id="modalAsso">
            <div class="modalassociacao">
                <button class="fechar" id="fechar">X</button>
                <div class="divModalAsso">
                    <h1>Dados</h1><br>
                    <div class="asso">
                        <span>Associação:</span><br><input placeholder="Nome da Associação"
                            id="input_associacao"><br><br>
                        <span>Faixa:</span> <br>
                        <select class="select" name="" id="id_select">
                            <option value="branca">Branca(7° Kyu)</option>
                            <option value="amarela">Amarela(6° Kyu)</option>
                            <option value="vermelha">Vermelha(5° Kyu)</option>
                            <option value="laranja">Laranja(4° Kyu)</option>
                            <option value="verde">Verde(3° Kyu)</option>
                            <option value="roxa">Roxa(2° Kyu)</option>
                            <option value="marrom">Marrom(1° Kyu)</option>
                            <option value="preta">Preta(1° Dan)</option>
                            <option value="preta">Preta(2° Dan)</option>
                            <option value="preta">Preta(3° Dan)</option>
                            <option value="preta">Preta(4° Dan)</option>
                            <option value="preta">Preta(5° Dan)</option>
                            <option value="preta">Preta(6° Dan)</option>
                            <option value="preta">Preta(7° Dan)</option>
                            <option value="preta">Preta(8° Dan)</option>
                            <option value="preta">Preta(9° Dan)</option>
                            <option value="preta">Preta(10° Dan)</option>

                        </select><br><br>
                        <span>Sensei: </span><br><input placeholder="Nome do Sensei" id="input_sensei"><br><br>
                        <span>Medalhas: </span><br><input placeholder="Quantidade de Medalhas"
                            id="input_qtdMedalhas"><br>
                    </div>
                    <button class="botao" onclick="atualizarDados()">Adicionar</button>
                </div>
            </div>
        </div>
        <!-- Karate -->

        <div class="container">
            <div class="perfil">
                <img src="" alt="">
                <div class="descricao">
                    <p>
                    <div id="id_nome">
                        Nome:
                    </div>

                    <div id="id_dados">
                        Associação: <br>
                        Sensei: <br>
                        Faixa: <br>
                        Medalhas: <br><br>
                    </div>
                    <button onclick="addDados()">Adicionar Dados</button>
                    </p>
                </div>
            </div>
        </div>
        <div class="tela">
            <div class="metricas">
                <!-- <div class="competicao">
                    <h2>Próxima competição: </h2>
                    <div class="data">
                        <p><b>Brasileiro:</b> 10/12/2023</p>
                        <a href="https://www.karatedobrasil.com/">Saiba Mais</a>
                    </div>
                </div> -->


                <div class="tabelas">
                    <h2>Treinos da semana: </h2><br>
                    <div class="dados">
                        <div class="junior">
                            <div class="titulo">
                                Quantidade de treinos
                            </div>
                        </div>

                        <div class="junior">
                            <div class="primeira">
                                1
                            </div>
                        </div>

                        <div class="junior">
                            <div class="segunda">
                                2 ou 3
                            </div>
                        </div>

                        <div class="junior">
                            <div class="terceira">
                                4 a 6
                            </div>
                        </div>

                        <div class="junior">
                            <div class="quarta">
                                7 a 12
                            </div>
                        </div>

                        <div class="junior">
                            <div class="quinta">
                                26
                            </div>
                        </div>
                    </div>

                    <div class="dados">

                        <div class="junior">
                            <div class="titulo">
                                Designação
                            </div>
                        </div>

                        <div class="junior">
                            <div class="primeira">
                                Júnior
                            </div>
                        </div>

                        <div class="junior">
                            <div class="segunda">
                                Cheng
                            </div>
                        </div>

                        <div class="junior">
                            <div class="terceira">
                                Karate Kid
                            </div>
                        </div>

                        <div class="junior">
                            <div class="quarta">
                                Sr. Miyagi
                            </div>
                        </div>

                        <div class="junior">
                            <div class="quinta">
                                Funakoshi
                            </div>
                        </div>
                    </div>
                    <div class="treino">
                        <p>Digite o dia e o horário do treino: </p>
                        <!-- <input class="campo" placeholder="Dia da Semana" id="input_dataTreino"> -->
                        <input class="campo" placeholder="Data(AAAA-MM-DD)" id="input_diaTreino">
                        <input class="campo" placeholder="Hora do treino" id="input_horaTreino"><br><br>
                        <button id="id_botaoKata" onclick="adicionarTreino()"> Adicionar Treino</button>
                    </div>
                    <div id="div_kata"></div>
                </div>
            </div>

            <div class="graficoTreinos">
                <div id="div_classificacao" class="classificacao">
                    <div class="treinos" id="div_treinosCadastrados"></div>
                    <!-- <p>Você é o karateca...</p>
                    <div class="nomePerfil" id="div_campoPerfil"> </div> -->
                </div>
                <div class="grafico">
                    <canvas class="grafico" id="myChart" height="100" width="100" style="margin-left: 30px"> </canvas>
                </div>

            </div>

            <div class="melhorar">
                <h2>Melhorias</h2>
                <div class="melhorias">
                    <div class="campos">
                        <span class="titulo">Dificuldade: </span>
                        <input class="campoMelhorar" placeholder="Dificuldade" id="input_dificuldade">
    
                        <input class="campoMelhorar" placeholder="Nível (0 a 10)" type="number" id="input_nivelDifi"><br> <br>
    
                        <span class="titulo">Facilidade: </span>
                        <input class="campoMelhorar" placeholder="Facilidade" id="input_facilidade">
    
                        <input class="campoMelhorar" placeholder="Nível (0 a 10)" type="number" id="input_nivelFaci"><br> <br>
                    </div>

                    <button class="botaoMelhorar" id="id_botaoMelhorar" onclick="adicionarMelhorias()"> Adicionar Melhorias</button>

                    <button id="id_botaoMelhorar" class="botaoMelhorar" onclick="listarMelhorias()">Listar</button>
                    <div id="div_melhorias">
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

    var feed2 = document.getElementById("div_treinosCadastrados");
    var mensagem = document.createElement("span");

    var listaTreinos = [];

    var idUsuario = sessionStorage.ID_USUARIO;

    //   Colocando o nome do usuário
    var nome = sessionStorage.NOME_USUARIO;

    id_nome.innerHTML = `Nome: ${nome}`;

    // Dados do perfil
    function atualizarDados() {
        // aguardar();

        var nomeAssoVar = input_associacao.value;
        var faixaVar = id_select.value;
        var nomeSenseiVar = input_sensei.value;
        var medalhasVar = input_qtdMedalhas.value;

        if (
            nomeAssoVar == "" ||
            faixaVar == "" ||
            nomeSenseiVar == "" ||
            medalhasVar == ""
        ) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Todos os campos estão em branco";

            // finalizarAguardar();
            return false;
        } else if (medalhasVar < 0) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Insira uma quantidade válida";

            // finalizarAguardar();
            return false;
        } else {
            setInterval(sumirMensagem, 5000);
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Atualizando dados...";
        }

        fetch("/dash/atualizarDados", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                nomeAssoServer: nomeAssoVar,
                faixaServer: faixaVar,
                nomeSenseiServer: nomeSenseiVar,
                medalhasServer: medalhasVar,
                fkUsuarioDadosServer: idUsuario

            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    console.log(resposta);

                    resposta.json().then(json => {
                        console.log(json);
                        console.log(JSON.stringify(json));
                        sessionStorage.NOMEASSO_DADOS = json.nomeAsso;
                        sessionStorage.FAIXA_DADOS = json.faixa;
                        sessionStorage.NOMESENSEI_DADOS = json.nomeSensei;
                        sessionStorage.MEDALHAS_DADOS = json.medalhas;
                        sessionStorage.FKUSUARIODADOS_DADOS = json.fkUsuarioDados;

                        setTimeout(() => {
                            cardErro.style.display = "block";
                            mensagem_erro.innerHTML =
                                "Atualizando dados...";
                        }, "2000");
                    });

                } else {
                    throw "Houve um erro ao tentar atualizar os dados!";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            })
        return false;
    }

    //  Colocando o resto dos dados
    var nomeAsso = sessionStorage.NOMEASSO_DADOS;
    var nomeSensei = sessionStorage.NOMESENSEI_DADOS;
    var faixa = sessionStorage.FAIXA_DADOS;
    var medalhas = sessionStorage.MEDALHAS_DADOS;

    id_dados.innerHTML = `
    Associação: ${nomeAsso} <br>
    Sensei: ${nomeSensei} <br>
    Faixa: ${faixa} <br>
    Medalhas: ${medalhas} <br><br>
    `;

    function sumirMensagem() {
        cardErro.style.display = "none";
    }

    var idUsuario = sessionStorage.ID_USUARIO;

    // Função para pegar os dados dos treinos
    function adicionarTreino() {
        // aguardar();

        var diaTreinoVar = input_diaTreino.value;
        var horaTreinoVar = input_horaTreino.value;

        if (
            diaTreinoVar == "" ||
            horaTreinoVar == ""
        ) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Todos os campos estão em branco";

            // finalizarAguardar();
            return false;
        } else if (diaTreinoVar < 1 || diaTreinoVar > 31) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Insira um dia válido";

            // finalizarAguardar();
            return false;
        } else if (horaTreinoVar < 0 || horaTreinoVar > 24) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Insira um horário válido";

            // finalizarAguardar();
            return false;
        } else {
            setInterval(sumirMensagem, 5000);
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Atualizando treinos...";
        }

        fetch("/dash/adicionarTreino", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                diaTreinoServer: diaTreinoVar,
                horaTreinoServer: horaTreinoVar,
                fkUsuarioTreinoServer: idUsuario

            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    console.log(resposta);

                    if (resposta.ok) {
                        cardErro.style.display = "block";
                        mensagem_erro.innerHTML = "Treino adicionado com sucesso!";

                        listaTreinos.push(diaTreinoVar);

                        setTimeout(() => {
                            cardErro.style.display = "block";
                            mensagem_erro.innerHTML =
                                "Atualizando dados...";
                        }, "2000");

                    }
                } else {
                    throw "Houve um erro ao tentar adicionar o treino!";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            })
        return false;
    }

    // Função para adicionar melhorias
    function adicionarMelhorias() {
        // aguardar();

        var dificuldadeVar = input_dificuldade.value;
        var nivelDifiVar = input_nivelDifi.value;
        var facilidadeVar = input_facilidade.value;
        var nivelFaciVar = input_nivelFaci.value;

        if (
            dificuldadeVar == "" &&
            nivelDifiVar == ""
        ) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Insira o nível da dificuldade";

            // finalizarAguardar();
            return false;
        }
        if (
            facilidadeVar == "" &&
            nivelFaciVar == ""
        ) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Insira o nível da facilidade";

            // finalizarAguardar();
            return false;
        } else if (nivelDifiVar < 0 || nivelDifiVar > 10 || nivelFaciVar < 0 || nivelFaciVar > 10) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Insira um nível válido";

            // finalizarAguardar();
            return false;
        } else {
            setInterval(sumirMensagem, 5000);
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Atualizando melhorias...";
        }

        fetch("/dash/adicionarMelhorias", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                dificuldadeServer: dificuldadeVar,
                nivelDifiServer: nivelDifiVar,
                facilidadeServer: facilidadeVar,
                nivelFaciServer: nivelFaciVar,
                fkUsuarioMelServer: idUsuario

            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    console.log(resposta);

                    if (resposta.ok) {
                        cardErro.style.display = "block";
                        mensagem_erro.innerHTML = "Melhoria adicionada com sucesso!";


                        setTimeout(() => {
                            cardErro.style.display = "block";
                            mensagem_erro.innerHTML =
                                "Atualizando dados...";
                        }, "2000");

                    }
                } else {
                    throw "Houve um erro ao tentar adicionar melhoria!";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            })
        return false;
    }


    function listarMelhorias() {
        console.log(idUsuario)
        fetch(`/dash/listarMelhorias/${idUsuario}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(function (resposta) {
                console.log("Dados recebidos: ", JSON.stringify(resposta));
                resposta.json()
                    .then((json) => {
                        console.log(json);
                        console.log(json[0].melhorias);

                        var quaisMelhorias = json[0].melhorias;
                        console.log(quaisMelhorias);

                        var melhor = document.getElementById("div_melhorias")
                        melhor.innerHTML = `<b>${quaisMelhorias}</b> <br>`;

                        div_melhorias.innerHTML = `
                        ${dificuldadeServer}<br>
                        ${nivelDifiServer}<br>
                        ${facilidadeServer}<br>
                        ${nivelFaciServer}
                        `;

                    })
            })


            .catch(function (erro) {
                console.error('Erro desconhecido na API.');
            }
            );
    }

    // Modal para adicionar dados
    function addDados() {
        const modal = document.getElementById('modalAsso')
        modal.classList.add('abrir')

        modal.addEventListener('click', (e) => {
            if (e.target.id == 'fechar' || e.target.id == 'modalAsso') {
                modal.classList.remove('abrir')
            }
        })
    }

    // Gráfico dos treinos

    function listarQtdTreinos() {
        console.log(idUsuario)
        fetch(`/dash/listarQtdTreinos/${idUsuario}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(function (resposta) {
                console.log("Dados recebidos: ", JSON.stringify(resposta));
                resposta.json()
                    .then((json) => {
                        console.log(json);
                        console.log(json[0].qtdTreino);

                        var qtsTreinos = json[0].qtdTreino;
                        console.log(qtsTreinos);

                        var qtdTotal = document.getElementById("div_treinosCadastrados")
                        qtdTotal.innerHTML = `<b>${qtsTreinos}</b>`;

                        if (qtsTreinos == 1) {
                            div_classificacao.innerHTML = `<h2><b>JKarateca nível júnior</b></h2> <span class="descricaoKarateca"> Seus treinos estão baixos, por enquanto. Karateca está no início de sua jornada, não desista! </span>`;
                        } else if (qtsTreinos <= 3) {
                            div_classificacao.innerHTML = `<h2><b>Karateca nível Cheng</b></h2> <span class="descricaoKarateca">Como o Cheng (Karate Kid) você está se esforçando, mas ainda pode mais um pouco. Força, karateca!</span>`;
                        } else if (qtsTreinos <= 6) {
                            div_classificacao.innerHTML = `<h2><b>Karateca nível Karate Kid</b></h2> <span class="descricaoKarateca">Como o próprio Karate Kid, você está treinando bastante para alcançar seu Sensei. Está no caminho certo!</span>`;
                        } else if (qtsTreinos <= 12) {
                            div_classificacao.innerHTML = `<h2><b>Karateca nível Sr. Miyagi</b></h2> <span class="descricaoKarateca">Seus treinos estão tão frequentes quanto do Sr. Miyagi, continue assim e virará um mestre também. </span>`;
                        } else if (qtsTreinos > 12) {
                            div_classificacao.innerHTML = `<h2><b>Karateca nível Funakoshi</b></h2> <span class="descricaoKarateca">Karateca do céu! Está treinando tanto quanto o criador da nossa arte! Ai que demais! </span>`;
                        } else { console.log(`Erro ao capturar perfil... valor da variavel ${qtsTreinos}`) }
                    })
            })


            .catch(function (erro) {
                console.error('Erro desconhecido na API.');
            }
            );
    }

    function buscarDia() {

        fetch(`/dash/buscarDia/${idUsuario}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao buscar os dados');
                }
                return response.json(); // Esta linha é essencial para extrair o corpo da resposta
            })
            .then(data => {
                // Ao utilizar then(data => { ... }), você está basicamente dizendo: "Quando os dados forem recebidos com sucesso do servidor, execute esta função e utilize esses dados dentro deste bloco de código." 

                const ctx = document.getElementById('myChart');

                const diaSemana = [
                    'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'
                ];


                const labels = data.map(item => item.dia_semana);
                const dados = data.map(item => item.qtdTreino);


                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Quantidade de Treinos por Dia',
                            data: dados,
                            backgroundColor: 'rgb(134, 64, 64)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Erro no grafico:', error);
            });
    }

    window.onload = function () {
        listarQtdTreinos();
        buscarDia();
    };
</script>