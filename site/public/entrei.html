<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENTREI - JULIA INADA DE FREITAS</title>
    <link rel="stylesheet" href="./css/entrei.css">
    <link rel="stylesheet" href="./css/modal.css">
    <!-- <script src="../src/js/addkata.js"></script> -->
    <!-- <script src="../src/js/script.js"></script> -->
    <!-- <script src="../src/js/entrei.js"></script> -->

    <style>
        /* ASSOCIAÇÃO */
        .modalAsso {
            width: 60%;
            height: 90%;
            position: fixed;
            top: 0;
            left: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1;
            overflow: auto;
            margin: 2% 20%;
            border-radius: 5%;
            box-shadow: 0 5px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 10px 1000px rgba(0, 0, 0, 0.491);
        }

        .modalAsso .modalassociacao {
            width: 50%;
            min-width: 400px;
            min-height: 300px;
            background-color: rgba(235, 144, 144, 0.75);
            backdrop-filter: blur(10px);
            height: 70%;
            padding: 10%;
            border-radius: 5%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }

        /* .modalAsso .modalassociacao img {
    width: 120%;
    height: 100%;
    cursor: pointer;
} */

        .modalAsso.abrir {
            display: flex;
        }

        @keyframes abrir {
            from {
                opacity: 0;
                transform: translate3d(0, -20px, -5px);
            }

            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        .abrir .modalAsso {
            animation: abrirfaixa 0.5s;
        }

        .fechar {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 8%;
            height: 8%;
            border-radius: 50%;
            border: 0;
            background-color: rgb(116, 54, 54);
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <!-- <script src="/site/src/js/login.js"></script> -->

    <div class="arm">
        <div class="alerta_erro">
            <div class="card_erro" id="cardErro">
                <span id="mensagem_erro"></span>
            </div>
        </div>

        <div class="modalAsso" id="modalAsso">
            <div class="modalassociacao">
                <button class="fechar" id="fechar">X</button>
                <div class="divModalAsso">
                    <h1>Dados</h1><br>
                    <div class="asso">
                        <span>Associação:</span><br><input placeholder="Nome da Associação"
                            id="input_associacao"><br><br>
                        <span>Faixa:</span> <br>
                        <select class="select" name="" id="id_select">
                            <option value="branca">Branca(7° Kyu)</option>
                            <option value="amarela">Amarela(6° Kyu)</option>
                            <option value="vermelha">Vermelha(5° Kyu)</option>
                            <option value="laranja">Laranja(4° Kyu)</option>
                            <option value="verde">Verde(3° Kyu)</option>
                            <option value="roxa">Roxa(2° Kyu)</option>
                            <option value="marrom">Marrom(1° Kyu)</option>
                            <option value="preta">Preta(1° Dan)</option>
                            <option value="preta">Preta(2° Dan)</option>
                            <option value="preta">Preta(3° Dan)</option>
                            <option value="preta">Preta(4° Dan)</option>
                            <option value="preta">Preta(5° Dan)</option>
                            <option value="preta">Preta(6° Dan)</option>
                            <option value="preta">Preta(7° Dan)</option>
                            <option value="preta">Preta(8° Dan)</option>
                            <option value="preta">Preta(9° Dan)</option>
                            <option value="preta">Preta(10° Dan)</option>

                        </select><br><br>
                        <span>Sensei: </span><br><input placeholder="Nome do Sensei" id="input_sensei"><br><br>
                        <span>Medalhas: </span><br><input placeholder="Quantidade de Medalhas"
                            id="input_qtdMedalhas"><br>
                    </div>
                    <button class="botao" onclick="atualizarDados()">Adicionar</button>
                </div>
            </div>
        </div>
        <!-- Karate -->

        <div class="container">
            <div class="perfil">
                <img src="" alt="">
                <div class="descricao">
                    <p>
                    <div id="id_nome">
                        Nome:
                    </div>

                    <div id="id_dados">
                        Associação: <br>
                        Sensei: <br>
                        Faixa: <br>
                        Medalhas: <br><br>
                    </div>
                    <button onclick="addDados()">Adicionar Dados</button>
                    </p>
                </div>
            </div>
        </div>
        <div class="tela">
            <div class="metricas">
                <!-- <div class="competicao">
                    <h2>Próxima competição: </h2>
                    <div class="data">
                        <p><b>Brasileiro:</b> 10/12/2023</p>
                        <a href="https://www.karatedobrasil.com/">Saiba Mais</a>
                    </div>
                </div> -->


                <div class="tabelas">
                    <h2>Treinos da semana: </h2><br>
                    <div class="dados">
                        <div class="junior">
                            <div class="titulo">
                                Quantidade de treinos
                            </div>
                        </div>

                        <div class="junior">
                            <div class="primeira">
                                1
                            </div>
                        </div>

                        <div class="junior">
                            <div class="segunda">
                                2 ou 3
                            </div>
                        </div>

                        <div class="junior">
                            <div class="terceira">
                                4 a 6
                            </div>
                        </div>

                        <div class="junior">
                            <div class="quarta">
                                7 a 12
                            </div>
                        </div>

                        <div class="junior">
                            <div class="quinta">
                                26
                            </div>
                        </div>
                    </div>

                    <div class="dados">

                        <div class="junior">
                            <div class="titulo">
                                Designação
                            </div>
                        </div>

                        <div class="junior">
                            <div class="primeira">
                                Júnior
                            </div>
                        </div>

                        <div class="junior">
                            <div class="segunda">
                                Cheng
                            </div>
                        </div>

                        <div class="junior">
                            <div class="terceira">
                                Karate Kid
                            </div>
                        </div>

                        <div class="junior">
                            <div class="quarta">
                                Sr. Miyagi
                            </div>
                        </div>

                        <div class="junior">
                            <div class="quinta">
                                Funakoshi
                            </div>
                        </div>
                    </div>
                    <div class="treino">
                        <p>Digite o dia e o horário do treino: </p>
                        <input class="campo" placeholder="Dia do treino" id="input_diaTreino">
                        <input class="campo" placeholder="Hora do treino" id="input_horaTreino"><br><br>
                        <button id="id_botaoKata" onclick="adicionarTreino()">Adicionar Treino</button>
                    </div>
                    <div id="div_kata"></div>
                </div>
            </div>

            <div class="graficoKata">
                <div class="classificacao">
                    <p>Por saber 8 katas, você atualmente é "Cheng"</p>
                </div>
                <div class="kata">
                    <div>
                        <canvas class="kata" id="arm5" style="position: relative; width: 100%; height: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

    var idUsuario = sessionStorage.ID_USUARIO;

    //   Colocando o nome do usuário
    var nome = sessionStorage.NOME_USUARIO;

    id_nome.innerHTML = `Nome: ${nome}`;

    // Dados do perfil
    function atualizarDados() {
        // aguardar();

        var nomeAssoVar = input_associacao.value;
        var faixaVar = id_select.value;
        var nomeSenseiVar = input_sensei.value;
        var medalhasVar = input_qtdMedalhas.value;

        if (
            nomeAssoVar == "" ||
            faixaVar == "" ||
            nomeSenseiVar == "" ||
            medalhasVar == ""
        ) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Todos os campos estão em branco";

            // finalizarAguardar();
            return false;
        } else if (medalhasVar < 0) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Insira uma quantidade válida";

            // finalizarAguardar();
            return false;
        } else {
            setInterval(sumirMensagem, 5000);
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Atualizando dados...";
        }

        fetch("/dash/atualizarDados", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                nomeAssoServer: nomeAssoVar,
                faixaServer: faixaVar,
                nomeSenseiServer: nomeSenseiVar,
                medalhasServer: medalhasVar,
                fkUsuarioDadosServer: idUsuario

            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    console.log(resposta);

                    resposta.json().then(json => {
                        console.log(json);
                        console.log(JSON.stringify(json));
                        sessionStorage.NOMEASSO_DADOS = json.nomeAsso;
                        sessionStorage.FAIXA_DADOS = json.faixa;
                        sessionStorage.NOMESENSEI_DADOS = json.nomeSensei;
                        sessionStorage.MEDALHAS_DADOS = json.medalhas;
                        sessionStorage.FKUSUARIODADOS_DADOS = json.fkUsuarioDados;

                        setTimeout(() => {
                            cardErro.style.display = "block";
                            mensagem_erro.innerHTML =
                                "Atualizando dados...";
                        }, "2000");
                    });

                } else {
                    throw "Houve um erro ao tentar atualizar os dados!";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            })
        return false;
    }

    //  Colocando o resto dos dados
    var nomeAsso = sessionStorage.NOMEASSO_DADOS;
    var nomeSensei = sessionStorage.NOMESENSEI_DADOS;
    var faixa = sessionStorage.FAIXA_DADOS;
    var medalhas = sessionStorage.MEDALHAS_DADOS;

    id_dados.innerHTML = `
    Associação: ${nomeAsso} <br>
    Sensei: ${nomeSensei} <br>
    Faixa: ${faixa} <br>
    Medalhas: ${medalhas} <br><br>
    `;

    function sumirMensagem() {
        cardErro.style.display = "none";
    }

    var idUsuario = sessionStorage.ID_USUARIO;

    // Função para pegar os dados dos treinos
    function adicionarTreino() {
        // aguardar();

        var diaTreinoVar = input_diaTreino.value;
        var horaTreinoVar = input_horaTreino.value;

        if (
            diaTreinoVar == "" ||
            horaTreinoVar == ""
        ) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Todos os campos estão em branco";

            // finalizarAguardar();
            return false;
        } else if (diaTreinoVar < 1 || diaTreinoVar > 31) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Insira um dia válido";

            // finalizarAguardar();
            return false;
        } else if (horaTreinoVar < 0 || horaTreinoVar > 24) {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Insira um horário válido";

            // finalizarAguardar();
            return false;
        } else {
            setInterval(sumirMensagem, 5000);
            cardErro.style.display = "block";
            mensagem_erro.innerHTML =
                "Atualizando treinos...";
        }

        fetch("/dash/adicionarTreino", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                diaTreinoServer: diaTreinoVar,
                horaTreinoServer: horaTreinoVar,
                fkUsuarioTreinoServer: idUsuario

            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    console.log(resposta);

                    if (resposta.ok) {
                        cardErro.style.display = "block";
                        mensagem_erro.innerHTML = "Treino adicionado com sucesso!";

                        setTimeout(() => {
                            cardErro.style.display = "block";
                            mensagem_erro.innerHTML =
                                "Atualizando dados...";
                        }, "2000");

                    }
                } else {
                    throw "Houve um erro ao tentar adicionar o treino!";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            })
        return false;
    }


    // Modal para adicionar dados
    function addDados() {
        const modal = document.getElementById('modalAsso')
        modal.classList.add('abrir')

        modal.addEventListener('click', (e) => {
            if (e.target.id == 'fechar' || e.target.id == 'modalAsso') {
                modal.classList.remove('abrir')
            }
        })
    }

    // Gráfico dos katas

    // const ctx = document.getElementById('arm5');

    // new Chart(ctx, {
    //     type: 'bar',
    //     data: {
    //         labels: ['Heian Shodan', 'Heian Nidan', 'Heian Sandan', 'Heian Yodan', 'Heian Godan', 'Tekki Shodan', 'Tekki Nidan', 'Tekki Sandan', 'Bassai Dai', 'Kanku Dai', 'Empi', 'Jion', 'Jitte', 'Hangetsu', 'Gankaku', 'Bassai Sho', 'Kanku Sho', 'Chinte', 'Unsu', 'Sochin', 'Nijushiho', 'Gojushiro Dai', 'Gojushiro Sho', 'Meikyo', 'Jiin', 'Wankan'],
    //         datasets: [{
    //             label: 'Kata',
    //             data: [11, 12, 90, 70, 2, 3, 73, 12, 12, 50, 12, 12, 12, 39, 12, 12, 12, 95, 12, 12, 12, 12, 29, 12, 12, 12],
    //             borderWidth: 1
    //         }]
    //     },
    //     options: {
    //         scales: {
    //             y: {
    //                 beginAtZero: true
    //             }
    //         }
    //     }
    // });

    window.onload = exibirTreinosDoUsuario();

    function exibirTreinosDoUsuario() {
        var usuario = JSON.parse(sessionStorage.ID_USUARIO);
        usuario.forEach(item => {
            document.getElementById("btnTreino").innerHTML += `
            <button class="btn-chart" onclick="exibirTreino(${item.id})" id="btnTreino${item.id}">${item.descricao}</button>
            `

            document.getElementById("graficos").innerHTML += `
                <div id="grafico${item.id}" class="display-none">
                    <h3 class="tituloGraficos">
                        <span id="tituloTreino${item.id}">${item.descricao}</span>
                    </h3>
                    <div class="graph">
                        <canvas id="myChartCanvas${item.id}"></canvas>
                    </div>
                    <div class="label-captura">
                        <p id="avisoCaptura${item.id}" style="color: white"></p>
                    </div>
                </div>
            `

            obterDadosGrafico(item.id)
        });

        if (usuario.length > 0) {
            exibirTreino(usuario[0].id)
        }
    }

    function alterarTitulo(idUsuario) {
        var tituloTreino = document.getElementById(`tituloTreino${idUsuario}`)
        var descricao = JSON.parse(sessionStorage.ID_USUARIO).find(item => item.id == idTreino).descricao;
        tituloTreino.innerHTML = "Últimas treinos do karateca <span style='color: #e6005a'>" + descricao + "</span>"
    }

    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function obterDadosGrafico(idUsuario) {

        alterarTitulo(idUsuario)

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/treino/ultimos/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idUsuario);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta, idUsuario) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Dia do Treino',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            },
            {
                label: 'Hora do Treino',
                data: [],
                fill: false,
                borderColor: 'rgb(199, 52, 52)',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro);
            dados.datasets[0].data.push(registro.Dia);
            dados.datasets[1].data.push(registro.Hora);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChartCanvas${idUsuario}`),
            config
        );

        setTimeout(() => atualizarGrafico(idUsuario, dados, myChart), 2000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(idUsuario, dados, myChart) {



        fetch(`/treino/tempo-real/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    obterdados(idUsuario);
                    // alertar(novoRegistro, idUsuario);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    let avisoCaptura = document.getElementById(`avisoCaptura${idUsuario}`)
                    avisoCaptura.innerHTML = ""


                    if (novoRegistro[0].Dia == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].Dia)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].registro); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].Dia); // incluir uma nova medida de umidade

                        dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                        dados.datasets[1].data.push(novoRegistro[1].Hora); // incluir uma nova medida de temperatura

                        myChart.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idUsuario, dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idUsuario, dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
</script>